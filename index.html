// ===== í†µí•© ë¶„ì„ í•¨ìˆ˜ (ì—¬ëŸ¬ íšŒì°¨ í†µí•©, íŒì—… ê²°ê³¼ + ë‹¹ì²¨ë²ˆí˜¸ í‘œì‹œ) =====
function runIntegratedAnalysis() {
    const startRound = currentBaseRound;
    const count = parseInt(document.getElementById('batchCount').value) || 10;
    if (count < 1 || count > 30) {
        alert('1~30 ì‚¬ì´ì˜ íšŸìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }

    // ê¸°ì¤€ íšŒì°¨ì˜ ì‹¤ì œ ë‹¹ì²¨ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
    const winData = FULL_DATA.find(row => row[0] === startRound);
    let winningNums = [], bonusNum = null;
    if (winData) {
        winningNums = winData.slice(1, 7);
        bonusNum = winData[7];
    }

    // 1. ë°ì´í„° ìˆ˜ì§‘
    let allMain = [];
    let allBonus = [];
    let mainWithRound = [];
    for (let i = 0; i < count; i++) {
        const round = startRound - i;
        const row = FULL_DATA.find(x => x[0] === round);
        if (row) {
            const mainNums = row.slice(1, 7);
            const bonus = row[7];
            mainNums.forEach(n => {
                allMain.push(n);
                const weight = 1.6 - i * 0.1;
                mainWithRound.push({ num: n, round: round, weight: Math.max(0.1, weight) });
            });
            allBonus.push(bonus);
        }
    }

    if (allMain.length === 0) {
        alert('ë¶„ì„ ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // 2. ë¯¸ì¶œìˆ˜ ê³„ì‚°
    let freq22 = {};
    for(let i=1; i<=45; i++) freq22[i] = 0;
    FULL_DATA.slice(0,22).forEach(row => {
        for(let j=1; j<=7; j++) if(row[j]) freq22[row[j]]++;
    });
    let zeroFreq = Object.keys(freq22).filter(n => freq22[n]===0).map(Number);

    // 3. ê°€ì¤‘ì¹˜ ì ìˆ˜
    let wScore = {};
    mainWithRound.forEach(item => {
        wScore[item.num] = (wScore[item.num] || 0) + item.weight;
    });
    zeroFreq.forEach(num => {
        if (wScore[num] !== undefined) wScore[num] += 0.2;
    });

    // 4. ì ìˆ˜ìˆœ ì •ë ¬
    let rankedMain = Object.keys(wScore).map(Number).sort((a, b) => {
        let aScore = wScore[a] || 0;
        let bScore = wScore[b] || 0;
        if (aScore > bScore) return -1;
        if (aScore < bScore) return 1;
        return a - b;
    });

    // 5. ê³ ì • 14ìˆ˜
    let top8 = rankedMain.slice(0, 8);
    let bottom6 = rankedMain.slice(-6);
    let full14Set = new Set([...top8, ...bottom6]);
    let full14 = Array.from(full14Set).sort((a,b)=>a-b);

    // 6. ì••ì¶•ìˆ˜ basket
    let topCount = Math.floor(currentCompress * 0.6);
    let bottomCount = currentCompress - topCount;
    topCount = Math.min(topCount, rankedMain.length);
    bottomCount = Math.min(bottomCount, rankedMain.length - topCount);
    let topPart = rankedMain.slice(0, topCount);
    let bottomPart = rankedMain.slice(-bottomCount);
    let basketSet = new Set([...topPart, ...bottomPart]);
    let basket = Array.from(basketSet).sort((a,b)=>a-b);

    // 7. ìƒì¡´ì
    let survivorsSet = new Set([...allMain, ...allBonus]);
    let survivors = Array.from(survivorsSet).sort((a,b)=>a-b);

    // 8. ë¹ ì§„ 4ê°œ
    let compressedOut = full14.filter(num => !basketSet.has(num));

    // 9. êµì²´ ë¡œì§ (ì§ì „ íšŒì°¨ ë‹¹ì²¨ë²ˆí˜¸)
    const prevRound = startRound - 1;
    const prevData = FULL_DATA.find(row => row[0] === prevRound);
    const lastWinning = prevData ? prevData.slice(1, 7) : [];

    let candidates = compressedOut.filter(num => lastWinning.includes(num));
    if (candidates.length < 2) {
        let sortedOut = [...compressedOut].sort((a, b) => (wScore[b] || 0) - (wScore[a] || 0));
        for (let num of sortedOut) {
            if (!candidates.includes(num) && candidates.length < 2) {
                candidates.push(num);
            }
        }
    }
    candidates = [...new Set(candidates)].slice(0, 2);

    let lowestTwo = [];
    if (candidates.length > 0) {
        let basketWithScore = basket.map(num => ({ num, score: wScore[num] || 0 }));
        basketWithScore.sort((a, b) => a.score - b.score);
        lowestTwo = basketWithScore.slice(0, candidates.length).map(item => item.num);

        let newBasket = [...basket];
        for (let i = 0; i < candidates.length; i++) {
            let idx = newBasket.indexOf(lowestTwo[i]);
            if (idx !== -1) {
                newBasket[idx] = candidates[i];
            }
        }
        newBasket = [...new Set(newBasket)].sort((a, b) => a - b);
        if (newBasket.length === basket.length) {
            basket = newBasket;
            compressedOut = full14.filter(num => !new Set(basket).has(num));
        }
    }

    let replacedIn = candidates;
    let replacedOut = lowestTwo;
    let middleBag = rankedMain.filter(num => !new Set(basket).has(num) && !new Set(full14).has(num));
    middleBag = [...middleBag, ...replacedOut].filter((v,i,a)=>a.indexOf(v)===i).sort((a,b)=>a-b);

    // 10. íŒì—… í‘œì‹œ (ë‹¹ì²¨ë²ˆí˜¸ í¬í•¨)
    showIntegratedPopup({
        range: `${startRound} ~ ${startRound - count + 1}íšŒ í†µí•©`,
        basket,
        survivors,
        compressedOut,
        full14,
        replacedIn,
        replacedOut,
        middleBag,
        compress: currentCompress,
        winningNums: winningNums,
        bonusNum: bonusNum,
        targetRound: startRound
    });
}

function showIntegratedPopup(data) {
    let replacedInHtml = data.replacedIn.length ? data.replacedIn.map(n => `<span class="replaced-in">${n}</span>`).join(', ') : 'ì—†ìŒ';
    let replacedOutHtml = data.replacedOut.length ? data.replacedOut.map(n => `<span class="replaced-out">${n}</span>`).join(', ') : 'ì—†ìŒ';
    let compressedOutHtml = data.compressedOut.map(n => 
        data.replacedIn.includes(n) ? `<span class="replaced-in">${n}</span>` : n
    ).join(', ');

    // ë‹¹ì²¨ë²ˆí˜¸ HTML ìƒì„±
    let winningHtml = '';
    if (data.winningNums && data.winningNums.length === 6) {
        winningHtml = `
            <div style="text-align:center; margin:8px 0; padding:4px; background:#222; border-radius:6px;">
                <span class="highlight-gold">ğŸ“Œ ${data.targetRound}íšŒ ë‹¹ì²¨ë²ˆí˜¸:</span> 
                ${data.winningNums.map(n => `<span class="base-num-box" style="margin:0 2px;">${n}</span>`).join('')}
                <span class="bonus-label">ë³´ë„ˆìŠ¤</span>
                <span class="base-num-box">${data.bonusNum}</span>
            </div>
        `;
    }

    let html = `
        <div style="font-size:12px; background:#1a1a1a; border-radius:8px; padding:10px;">
            <div style="text-align:center; margin-bottom:8px; color:var(--accent); font-weight:bold;">ğŸ“Š ${data.range}</div>
            ${winningHtml}
            <div><span class="highlight-gold">â˜… ì••ì¶•ìˆ˜ ${data.compress}</span></div>
            <div>ìƒì¡´ì ${data.survivors.length}ìˆ˜: ${data.survivors.join(', ')}</div>
            <div>AI ì¶”ì²œ ${data.basket.length}ìˆ˜: ${data.basket.join(', ')}</div>
            <div>ğŸ”» 14ìˆ˜ì—ì„œ ë¹ ì§„ ${data.compressedOut.length}ê°œ (êµì²´ í›„ ë‚¨ì€): ${compressedOutHtml}</div>
            <div style="margin-top:4px;">
                <span style="color:#ff6666;">â–¶ êµì²´ëœ ë²ˆí˜¸: ${replacedInHtml}</span><br>
                <span style="color:#66aaff;">â—€ êµì²´ë‹¹í•œ ë²ˆí˜¸: ${replacedOutHtml}</span><br>
                <span style="color:#aaa;">ğŸ“¦ B bag: ${data.middleBag.join(', ') || 'ì—†ìŒ'}</span>
            </div>
        </div>
        <div style="text-align:center; margin-top:12px;">
            <button class="game-btn" onclick="this.closest('.popup-overlay').remove()">ë‹«ê¸°</button>
        </div>
    `;

    const popup = document.createElement('div');
    popup.className = 'popup-overlay';
    popup.innerHTML = `<div class="popup-content" style="max-width:450px;">${html}</div>`;
    document.body.appendChild(popup);
    popup.addEventListener('click', e => { if (e.target === popup) popup.remove(); });
}
